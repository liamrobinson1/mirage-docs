
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "gallery/000-work-in-progress/read_fit_brdf_databases.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_gallery_000-work-in-progress_read_fit_brdf_databases.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_gallery_000-work-in-progress_read_fit_brdf_databases.py:


Fitting BRDF Databases
======================

.. GENERATED FROM PYTHON SOURCE LINES 5-58




.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Elapsed time: 4.22e+00 seconds
    [0.06964667 0.06964667 0.06964667 ... 0.11265767 0.11809033 0.08556367]
    206.64434947075068
    206.6443521821524
    206.64435347631107
    206.64434933838646
    159.07774675993102
    159.07774365788603
    159.0777432286337
    159.0777466879901
    65.93512486663758
    65.9351252205776
    65.93512666747628
    65.93512485584577
    1178.5198487457142
    1178.5198518724412
    1178.5198454689562
    1178.5198483118688
    80.6565383038864
    80.65654107903309
    80.65653712901397
    80.65653830118653
    64.02467151769466
    64.02467260007336
    64.02467260855678
    64.024671513073
    61.38417700113017
    61.3841773967019
    61.38417735432505
    61.38417699994308
    61.0695393193132
    61.06953928577124
    61.069539266732974
    61.069539318902926
    61.06364491420089
    61.063644915533324
    61.06364492243257
    61.06364491372016
    61.06299400141511
    61.0629940058883
    61.06299400944294
    61.062994000944975
    61.06079307419075
    61.06079309123214
    61.06079308147758
    61.06079307375927
    61.05575389913068
    61.05575392380082
    61.0557539061797
    61.05575389878628
    61.04792038849515
    61.047920410906436
    61.04792039457095
    61.04792038830072
    61.04301175854857
    61.04301176596345
    61.04301176218427
    61.04301175849191
    61.04247215524377
    61.04247215579046
    61.04247215628984
    61.042472155231565
    61.0424461094403
    61.042446109016055
    61.042446109555755
    61.04244610943798
    61.04244537319066
    61.04244537295068
    61.04244537316717
    61.04244537319151
    61.042445261987325
    61.04244526191079
    61.042445261979665
    61.04244526198788
    61.04244544464939
    61.04244544469182
    61.042445444652856
    61.042445444648685
    61.04244526731327
    61.04244526725649
    61.04244526730918
    61.04244526731301
    61.04244526243232
    61.042445262360445
    61.04244526242755
    61.042445262432125
    61.04244526202684
    61.042445261946746
    61.042445262016265
    61.04244526202688
    61.04244526198747
    61.04244526190569
    61.0424452619767
    61.042445261987595
    61.04244526198961
    61.04244526190688
    61.04244526198021
    61.04244526199043
    61.04244526198717
    61.04244526190903
    61.04244526198051
    61.04244526198703
    61.042445261986124
    61.04244526190963
    61.04244526198192
    61.042445261986586
    61.04244526198435
    61.042445261908135
    61.04244526197995
    61.04244526198453
    61.04244526198209
    61.04244526190012
    61.04244526197292
    61.04244526198174
    61.04244526196207
    61.042445261881404
    61.04244526195275
    61.04244526196238
    61.04244526187885
    61.04244526179802
    61.04244526187058
    61.04244526187818
    61.04244526155127
    61.04244526146978
    61.04244526153845
    61.04244526155084
    61.0424452603043
    61.04244526023065
    61.042445260296155
    61.04244526030365
    61.042445256391254
    61.042445256341985
    61.0424452563811
    61.042445256391034
    61.04244525395124
    61.042445253965035
    61.04244525395875
    61.04244525395109
    61.04244525362302
    61.04244525361988
    61.04244525362513
    61.042445253622255
    61.04244525360378
    61.04244525360347
    61.04244525360457
    61.042445253603
    61.042445253626866
    61.042445253625786
    61.04244525362117
    61.04244525362711
    61.04244525359649
    61.042445253590856
    61.04244525359201
    61.04244525359674
    61.04244525359251
    61.04244525359361
    61.04244525359233
    61.042445253592064
    61.04244525359231
    61.042445253592554
    61.04244525359291
    61.04244525359211
    61.04244525359122
    61.04244525359328
    61.04244525359361
    61.0424452535911
    61.04244525359236
    61.0424452535922
    61.0424452535927
    61.04244525359235
    61.04244525358944
    61.04244525359372
    61.04244525359393
    61.04244525358911
    61.04244525359136
    61.042445253593044
    61.042445253589655
    61.042445253591474
    61.04244525359196
    61.04244525359082
    61.04244525359202
    61.04244525359211
    61.04244525358919
    61.0424452535937
    61.04244525359424
    61.04244525358914
    61.04244525358919
    61.0424452535937
    61.04244525359424
    61.04244525358914
    61.04244525359124
    61.042445253592824
    61.04244525359086
    61.0424452535901
    61.042445253589094
    61.04244525359375
    61.042445253594266
    61.042445253589314
    61.042445253593115
    61.042445253592156
    61.042445253591886
    61.042445253593804
    61.042445253593506
    61.042445253591644
    61.042445253591595
    61.04244525359346
    61.04244525359138
    61.042445253592696
    61.04244525359298
    61.0424452535912
    61.04244525358911
    61.04244525359383
    61.04244525359427
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.042445253594266
    61.042445253589314
    61.04244525358911
    61.04244525359382
    61.04244525359427
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.042445253594266
    61.042445253589314
    61.0424452535891
    61.042445253593804
    61.042445253594266
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.042445253594266
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.0424452535891
    61.04244525359375
    61.042445253594266
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.0424452535891
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.0424452535891
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.0424452535891
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.0424452535891
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.0424452535891
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253589094
    61.04244525359375
    61.04244525359426
    61.042445253589314
    61.042445253593115
    61.042445253591
    61.042445253592014
    61.04244525359432
    61.04244525358916
    61.042445253588994
    61.04244525359499
    61.04244525359357
    61.04244525358862
    61.04244525359328
    61.0424452535907
    61.04244525359274
    61.042445253590586
    61.042445253591524
    61.042445253589634
    [[0.06964667 0.06562441]
     [0.06964667 0.06562441]
     [0.06964667 0.06562441]
     ...
     [0.11265767 0.05654149]
     [0.11809033 0.05653102]
     [0.08556367 0.05652762]]
    5.575048197011347
    Brdf(name='cook-torrance', cd=0.20616820531806226, cs=-0.0015008986809828548, n=11.101865347195085)






|

.. code-block:: default


    import os
    import subprocess

    import matplotlib.pyplot as plt
    import numpy as np
    import pyvista as pv
    from scipy.optimize import minimize

    import mirage as mr

    _DB_DIR = "/Users/liamrobinson/Documents/brdfmachine/BRDFDatabase"
    _EXE_DIR = os.path.join(_DB_DIR, "code")

    brdf_file = "orange-paint"
    brdf_model = "cook-torrance"
    brdf_path = os.path.join(_DB_DIR, "brdfs", f"{brdf_file}.binary")
    cmd = f"cd {_EXE_DIR} && ./BRDFRead {brdf_path}"

    mr.tic()
    proc = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE, text=True)
    brdf_info = proc.stdout
    lines = brdf_info.strip().split("\n")
    data = np.array([[float(value) for value in line.split()] for line in lines])
    # theta_in, phi_in, theta_out, phi_out, red, green, blue
    # theta angle from N, phi angle from tangent
    mr.toc()

    n = np.tile(np.array([[0.0, 0.0, 1.0]]), (data.shape[0], 1))
    sv = mr.stack_mat_mult_vec(mr.r1(data[:, 0]), n)
    n_to_ov_rotm = mr.stack_mat_mult_mat(mr.r3(data[:, 3] - data[:, 1]), mr.r1(data[:, 2]))
    ov = mr.stack_mat_mult_vec(n_to_ov_rotm, n)

    b_true = np.mean(data[:, -3:], axis=1).flatten()

    print(b_true)


    def eval_brdf_fit(x: np.ndarray) -> float:
        brdf = mr.Brdf(brdf_model, cd=x[0], cs=x[1], n=x[2], validate=False)
        b_est = brdf.eval(sv, ov, n).flatten()
        err = np.linalg.norm(b_true - b_est)
        print(err)
        return err


    sol = minimize(eval_brdf_fit, x0=(0.5, 0.5, 10))

    brdf_opt = mr.Brdf(brdf_model, cd=sol.x[0], cs=sol.x[1], n=sol.x[2], validate=False)
    b_opt = brdf_opt.eval(sv, ov, n).flatten()
    print(np.vstack((b_true, b_opt)).T)
    print(np.max(np.abs(b_true - b_opt)))
    print(brdf_opt)


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 1 minutes  31.857 seconds)


.. _sphx_glr_download_gallery_000-work-in-progress_read_fit_brdf_databases.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example




    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: read_fit_brdf_databases.py <read_fit_brdf_databases.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: read_fit_brdf_databases.ipynb <read_fit_brdf_databases.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
