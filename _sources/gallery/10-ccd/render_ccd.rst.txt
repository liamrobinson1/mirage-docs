
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "gallery/10-ccd/render_ccd.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_gallery_10-ccd_render_ccd.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_gallery_10-ccd_render_ccd.py:


CCD Rendering
=============

Renders a synthetic CCD image of an observation taken by the POGS telescope

.. GENERATED FROM PYTHON SOURCE LINES 7-17

.. code-block:: default


    import os

    import matplotlib.pyplot as plt
    import numpy as np
    import pyvista as pv

    import mirage as mr
    import mirage.vis as mrv








.. GENERATED FROM PYTHON SOURCE LINES 18-19

Loading a fits image from the Purdue Optical Ground Station

.. GENERATED FROM PYTHON SOURCE LINES 19-41

.. code-block:: default


    ccd_dir = os.path.join(os.environ["SRCDIR"], "..", "data")
    # fits_path = os.path.join(ccd_dir, "00130398.fit") # 3 in belt
    fits_path = os.path.join(os.environ["SRCDIR"], "..", "00161295.48859.fit")  # gps
    # fits_path = "/Users/liamrobinson/Library/CloudStorage/OneDrive-purdue.edu/2022-09-18_GPS_PRN14/00146814.fit"

    # fits_path = os.path.join(
    #     os.environ["SRCDIR"], "..", "00161341.GALAXY_23__TELSTAR_13__#27854U.fit"
    # )
    # fits_path = "/Users/liamrobinson/Documents/PyLightCurves/00161344.fit" # recent
    # fits_path = os.path.join(os.environ["SRCDIR"], "..", "00161298.Jupiter.fit")

    fits_dict = mr.info_from_fits(fits_path)
    obs_dates = fits_dict["dates"]
    observing_station = fits_dict["station"]
    obs_dirs_eci = fits_dict["look_dirs_eci"]
    ccd_adu = fits_dict["ccd_adu"]
    br_parabola_obs = fits_dict["br_parabola"]

    obs_dir_eci_mid = mr.hat(np.sum(obs_dirs_eci, axis=0))
    date_mid = obs_dates[1] - (obs_dates[1] - obs_dates[0]) / 2








.. GENERATED FROM PYTHON SOURCE LINES 42-43

Let's synthesize a CCD image for the same observation conditions

.. GENERATED FROM PYTHON SOURCE LINES 43-54

.. code-block:: default


    # pl = pv.Plotter()
    # mrv.render_observation_scenario(
    #     pl,
    #     dates=obs_dates,
    #     station=observing_station,
    #     look_dirs_eci=obs_dirs_eci,
    #     sensor_extent_km=20e3,
    # )
    # pl.show()








.. GENERATED FROM PYTHON SOURCE LINES 55-56

Synthesizing the same image

.. GENERATED FROM PYTHON SOURCE LINES 58-59

Let's synthesize a CCD image for the same observation conditions

.. GENERATED FROM PYTHON SOURCE LINES 59-104

.. code-block:: default


    observing_station.telescope.fwhm = 4

    obj = mr.SpaceObject("matlib_hylas4.obj", identifier=26853)
    r_obj_eci = obj.propagate(obs_dates)

    sv = mr.sun(obs_dates)
    nadir = -mr.hat(r_obj_eci)
    attitude = mr.AlignedAndConstrainedAttitude(
        v_align=nadir,
        v_const=sv,
        dates=obs_dates,
        axis_order=(1, 2, 0),
    )
    obj_lc_sampler, _ = observing_station.observe_light_curve(
        obj,
        attitude,
        mr.Brdf("phong"),
        date_mid,
        use_engine=True,
        instances=1,
        model_scale_factor=1,
        rotate_panels=True,
    )
    lc_adu = obj_lc_sampler()[0]
    lc_adu = 1e6 * np.ones(lc_adu.shape)

    catalog = mr.StarCatalog("gaia", observing_station, obs_dates[0])

    up_dir_eci = observing_station.telescope.up_direction_eci(obs_dir_eci_mid)

    mr.tic()
    adu_grid_streaked_sampled = observing_station.telescope.ccd.generate_ccd_image(
        date_mid,
        fits_dict["integration_time"],
        observing_station,
        obs_dir_eci_mid,
        [fits_dict["ra_rate"], fits_dict["dec_rate"]],
        lc_adu,
        catalog,
        up_dir_eci=up_dir_eci,
    )
    mr.toc()






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    WARNING: no observation constraints assigned!
    Objects in frame 1:
    NAVSTAR 81 (USA 319)
    Elapsed time: 5.86e+00 seconds




.. GENERATED FROM PYTHON SOURCE LINES 105-106

Let's take a look at the real and synthetic CCD images

.. GENERATED FROM PYTHON SOURCE LINES 106-130

.. code-block:: default


    ccd_adu = np.clip(ccd_adu - br_parabola_obs, 1, np.inf)
    adu_grid_streaked_sampled = np.clip(
        adu_grid_streaked_sampled - mr.image_background_parabola(adu_grid_streaked_sampled),
        1,
        np.inf,
    )


    plt.figure(figsize=(8, 4))
    plt.subplot(1, 2, 1)
    plt.imshow(np.log10(ccd_adu), cmap="gray")
    mrv.texit(f"POGS CCD", "", "", grid=False)
    plt.colorbar(cax=mrv.get_cbar_ax(), label="$\log_{10}(ADU)$")
    plt.clim(*np.percentile(np.log10(ccd_adu), [0.1, 99.9]))

    plt.subplot(1, 2, 2)
    plt.imshow(np.log10(adu_grid_streaked_sampled), cmap="gray")
    mrv.texit(f"Synthetic CCD", "", "", grid=False)
    plt.colorbar(cax=mrv.get_cbar_ax(), label="$\log_{10}(ADU)$")
    plt.clim(*np.percentile(np.log10(adu_grid_streaked_sampled), [0.1, 99.9]))
    plt.tight_layout()
    plt.show()




.. image-sg:: /gallery/10-ccd/images/sphx_glr_render_ccd_001.png
   :alt: POGS CCD, Synthetic CCD
   :srcset: /gallery/10-ccd/images/sphx_glr_render_ccd_001.png, /gallery/10-ccd/images/sphx_glr_render_ccd_001_2_00x.png 2.00x
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 131-132

Plotting the two images on top of eachother

.. GENERATED FROM PYTHON SOURCE LINES 132-138

.. code-block:: default


    plt.figure(figsize=(4, 4))
    plt.imshow(np.log10(ccd_adu), cmap="gray")
    plt.imshow(np.log10(adu_grid_streaked_sampled), cmap="cool", alpha=0.2)
    plt.show()




.. image-sg:: /gallery/10-ccd/images/sphx_glr_render_ccd_002.png
   :alt: render ccd
   :srcset: /gallery/10-ccd/images/sphx_glr_render_ccd_002.png, /gallery/10-ccd/images/sphx_glr_render_ccd_002_2_00x.png 2.00x
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 139-140

Looking at the residual noise after subtracting off the parabolic background from the real image

.. GENERATED FROM PYTHON SOURCE LINES 140-155

.. code-block:: default


    ccd_adu_minus_br = observing_station.telescope.ccd.subtract_parabola(ccd_adu)
    real_br_mask = mr.image_background_naive(ccd_adu_minus_br)[0]
    real_br_pixels = np.ma.array(ccd_adu_minus_br, mask=~real_br_mask)
    synth_adu_minus_br = observing_station.telescope.ccd.subtract_parabola(
        adu_grid_streaked_sampled
    )
    synth_br_mask = mr.image_background_naive(synth_adu_minus_br)[0]
    synth_br_pixels = np.ma.array(synth_adu_minus_br, mask=~synth_br_mask)
    print(f"Real background variance: {np.var(ccd_adu_minus_br[real_br_mask])} [ADU^2]")
    print(
        f"Synthetic background variance: {np.var(synth_adu_minus_br[synth_br_mask])} [ADU^2]"
    )






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Real background variance: 113.7439377206357 [ADU^2]
    Synthetic background variance: 505.4671421456516 [ADU^2]




.. GENERATED FROM PYTHON SOURCE LINES 156-157

Plotting the same, with the parabolic background subtracted from the real image

.. GENERATED FROM PYTHON SOURCE LINES 157-174

.. code-block:: default


    cbar_kwargs = dict(label="$ADU$")
    plt.figure(figsize=(8, 4))
    plt.subplot(1, 2, 1)
    plt.imshow(real_br_pixels, cmap="plasma")
    mrv.texit(f"POGS CCD Background Pixels", "", "", grid=False)
    plt.colorbar(cax=mrv.get_cbar_ax(), **cbar_kwargs)
    plt.clim(0, 300)

    plt.subplot(1, 2, 2)
    plt.imshow(synth_br_pixels, cmap="plasma")
    mrv.texit(f"Synthetic CCD Background Pixels", "", "", grid=False)
    plt.colorbar(cax=mrv.get_cbar_ax(), **cbar_kwargs)
    plt.clim(0, 300)
    plt.tight_layout()
    plt.show()




.. image-sg:: /gallery/10-ccd/images/sphx_glr_render_ccd_003.png
   :alt: POGS CCD Background Pixels, Synthetic CCD Background Pixels
   :srcset: /gallery/10-ccd/images/sphx_glr_render_ccd_003.png, /gallery/10-ccd/images/sphx_glr_render_ccd_003_2_00x.png 2.00x
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 175-176

Inspecting the backgrounds

.. GENERATED FROM PYTHON SOURCE LINES 176-212

.. code-block:: default


    frac_cuts = (1e-4, 5e-3)
    thresh = slice(
        int(frac_cuts[0] * adu_grid_streaked_sampled.size),
        int((1 - frac_cuts[1]) * adu_grid_streaked_sampled.size),
    )
    synth_br_data = np.sort(adu_grid_streaked_sampled.flatten())[thresh][::100]
    real_br_data = np.sort(ccd_adu.flatten())[thresh][::100]

    synth_br = np.mean(synth_br_data)
    real_br = np.mean(real_br_data)

    print(f"Synthetic background: {synth_br} [ADU]")
    print(f"Real background: {real_br} [ADU]")

    synth_br_poisson_samples = np.random.poisson(synth_br, synth_br_data.size)
    real_br_poisson_samples = np.random.poisson(real_br, real_br_data.size)

    plt.subplot(1, 2, 2)
    bins = np.arange(np.min(synth_br_data), np.max(synth_br_data))
    hist_args = dict(density=True, bins=bins, alpha=0.7)
    plt.hist(synth_br_data, **hist_args)
    plt.hist(synth_br_poisson_samples, **hist_args)
    mrv.texit("Synthetic backgrounds", "ADU", "Density", ["Image", "Poisson fit"])

    plt.subplot(1, 2, 1)
    hist_args["bins"] = np.arange(
        np.min(real_br_poisson_samples), np.max(real_br_poisson_samples)
    )
    plt.hist(real_br_data, **hist_args)
    plt.hist(real_br_poisson_samples, **hist_args)
    mrv.texit("Real backgrounds", "ADU", "Density", ["Image", "Poisson fit"])

    plt.tight_layout()
    plt.gcf().set_size_inches(8, 4)
    plt.show()



.. image-sg:: /gallery/10-ccd/images/sphx_glr_render_ccd_004.png
   :alt: Synthetic backgrounds, Real backgrounds
   :srcset: /gallery/10-ccd/images/sphx_glr_render_ccd_004.png, /gallery/10-ccd/images/sphx_glr_render_ccd_004_2_00x.png 2.00x
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Synthetic background: 11.023618002607593 [ADU]
    Real background: 5.857372967661838 [ADU]





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  30.356 seconds)


.. _sphx_glr_download_gallery_10-ccd_render_ccd.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example




    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: render_ccd.py <render_ccd.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: render_ccd.ipynb <render_ccd.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
